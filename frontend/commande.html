<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Commandes</title>
  
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    h2 {
      color: #333;
    }
    input, select, button {
      margin: 5px;
      padding: 6px;
    }
    .commande {
       background: #e74c3c; 
  color: white;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .composition-list div {
      margin-left: 20px;
    }
    .produit-bloc, .supp-bloc {
      margin-bottom: 10px;
      padding: 10px;
      background: #e9e9e9;
      border-radius: 5px;
    }
    .btn-retour {
      background-color: #444;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <button class="btn-retour" onclick="window.location.href='index.html'">⬅ Retour au menu principal</button>

  <h2>Créer une commande</h2>
  <form id="commandeForm">
    <input type="text" id="nomClient" placeholder="Nom du client" required>
    <input type="datetime-local" id="heureLivraison" required>

    <h3>Produits / Menus</h3>
    <div id="produitsContainer"></div>
    <button type="button" onclick="addProduit()">+ Ajouter un produit/menu</button>

    <h3>Suppléments</h3>
    <div id="supplementsContainer"></div>
    <button type="button" onclick="addSupplement()">+ Ajouter un supplément</button>

    <br><br>
    <button type="submit">Créer la commande</button>
  </form>

  <hr>
  <h2>Liste des commandes</h2>
  <div id="listeCommandes"></div>

  <script>
    const apiUrl = 'http://localhost:3000/api/orders';

    // Ajouter produit/menu
    function addProduit() {
      const div = document.createElement('div');
      div.className = 'produit-bloc';
      div.innerHTML = `
        <select class="type">
          <option value="Produit">Produit</option>
          <option value="Menu">Menu</option>
        </select>
        <input type="text" class="nom" placeholder="Nom du produit/menu">
        <input type="number" class="quantite" value="1" min="1">

        <div class="composition-container" style="display:none; margin-top:10px;">
          <label>Composition :</label>
          <div class="composition-list"></div>
          <button type="button" class="add-compo">+ Ajouter un élément</button>
        </div>
        <button type="button" onclick="this.parentElement.remove()">❌ Supprimer</button>
      `;
      document.getElementById('produitsContainer').appendChild(div);

      const typeSelect = div.querySelector('.type');
      const compoContainer = div.querySelector('.composition-container');
      const compoList = div.querySelector('.composition-list');

      typeSelect.addEventListener('change', () => {
        if (typeSelect.value === 'Menu') {
          compoContainer.style.display = 'block';
        } else {
          compoContainer.style.display = 'none';
          compoList.innerHTML = '';
        }
      });

      div.querySelector('.add-compo').addEventListener('click', () => {
        const row = document.createElement('div');
        row.innerHTML = `
          <input type="text" class="compo-nom" placeholder="Nom élément">
          <input type="number" class="compo-quantite" value="1" min="1" style="width:60px;">
          <button type="button" onclick="this.parentElement.remove()">❌</button>
        `;
        compoList.appendChild(row);
      });
    }

    // Ajouter supplément
    function addSupplement() {
      const div = document.createElement('div');
      div.className = 'supp-bloc';
      div.innerHTML = `
        <input type="text" class="nom-supp" placeholder="Nom du supplément">
        <input type="number" class="prix-supp" placeholder="Prix" step="0.01">
        <input type="number" class="qte-supp" value="1" min="1">
        <button type="button" onclick="this.parentElement.remove()">❌</button>
      `;
      document.getElementById('supplementsContainer').appendChild(div);
    }

    // Envoi du formulaire
    document.getElementById('commandeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const produitsDivs = Array.from(document.querySelectorAll('#produitsContainer > div'));
      const produits = produitsDivs.map(div => {
        const type = div.querySelector('.type').value;
        const nom = div.querySelector('.nom').value.trim();
        const quantite = parseInt(div.querySelector('.quantite').value) || 1;

        const composition = [];
        if (type === 'Menu') {
          const compoDivs = div.querySelectorAll('.composition-list > div');
          compoDivs.forEach(c => {
            const nomCompo = c.querySelector('.compo-nom').value.trim();
            const qteCompo = parseInt(c.querySelector('.compo-quantite').value) || 1;
            if (nomCompo) {
              composition.push({ nom: nomCompo, quantite: qteCompo });
            }
          });
        }

        return { type, nom, quantite, composition };
      });

      const suppDivs = Array.from(document.querySelectorAll('#supplementsContainer > div'));
      const supplements = suppDivs.map(div => ({
        nom: div.querySelector('.nom-supp').value.trim(),
        prix: parseFloat(div.querySelector('.prix-supp').value),
        quantite: parseInt(div.querySelector('.qte-supp').value) || 1
      }));

      const data = {
        nomClient: document.getElementById('nomClient').value,
        heureLivraison: document.getElementById('heureLivraison').value,
        produits,
        supplements
      };

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      alert(result.message || 'Commande enregistrée !');
      document.getElementById('commandeForm').reset();
      document.getElementById('produitsContainer').innerHTML = '';
      document.getElementById('supplementsContainer').innerHTML = '';
      getCommandes();
    });

    // Afficher commandes
    async function getCommandes() {
      const res = await fetch(apiUrl);
      const commandes = await res.json();
      const container = document.getElementById('listeCommandes');
      container.innerHTML = '';

      commandes.forEach(c => {
        const div = document.createElement('div');
        div.className = 'commande';
        div.innerHTML = `
          <strong>Client :</strong> ${c.nomClient}<br>
          <strong>Livraison :</strong> ${new Date(c.heureLivraison).toLocaleString()}<br>
          <strong>État :</strong> ${c.etat}<br>
          <strong>Total :</strong> ${c.prixTotal.toFixed(2)} €<br>
          <strong>Produits :</strong><br>
          <ul>
            ${c.produits.map(p =>
              `<li>${p.type} - ${p.nom} x${p.quantite}
              ${p.composition && p.composition.length ? `
                <ul>
                  ${p.composition.map(co => `<li>${co.nom} (${co.quantite})</li>`).join('')}
                </ul>` : ''}</li>`
            ).join('')}
          </ul>
          <strong>Suppléments :</strong>
          <ul>
            ${c.supplements.map(s => `<li>${s.nom} - ${s.prix} € x${s.quantite}</li>`).join('')}
          </ul>
          <button onclick="deleteCommande('${c._id}')">Supprimer</button>
        `;
        container.appendChild(div);
      });
    }

    async function deleteCommande(id) {
      if (confirm('Supprimer cette commande ?')) {
        await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
        getCommandes();
      }
    }

    // Initialisation
    getCommandes();
  </script>
  <div id="header"></div>

<script>
  fetch('header.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('header').innerHTML = html;
    });
</script>

</body>
</html>
